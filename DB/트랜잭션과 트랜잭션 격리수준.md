2020.11.18

트랜잭션 - 데이터의 정합성을 보장하기 위한 기능

- 여러개의 쿼리가 조합되었을 때만 의미있는 것이 아니라, 하나의 논리적인 작업 셋에 대하여서 쿼리의 수와 상관없이 100% 적용이 되거나, 적용되지 않아야 된다는 것을 말하는 것이다. (원자성)
- 트랜잭션을 사용할 때 최대한 작은 범위에 사용하는 것이 상대적으로 성능의 이점이 있다.
    - 하나의 작업이 커넥션을 금방 끊어야(사용 종료해야) 그 시점동안 더 많은 커넥션을 사용할 수 있게 된다.

트랜잭션 격리 수준이란?

동시에 여러 트랜잭션이 처리될 때, 특정한 트랜잭션이 다른 트랜잭션에서 변경하거나 조회하는 데이터를 볼 수 있도록 허용할지 말지를 결정하는 수준을 말한다.

트랜잭션 격리 수준이 뒤로 갈 수록 데이터 격리 정도가 높아지며, 동시성이 떨어진다.

(격리 수준이 SERIALIZABLE 이 아닌 이상 Mysql 서버의 처리 성능에 큰 영향을 주진 않는다.)

<br/>
<br/>

**3가지 부정합 문제**

- **Dirty read**
    - 트랜잭션 작업이 완료되지 않았는데, 다른 트랜잭션에서 볼 수 있게 되는 현상
- **Non-Repeatable read**
    - 한 트랜잭션에서 같은 쿼리를 두 번 수행할 때, 두 쿼리의 결과가 상이하게 나타나는 비일관성 현상
    - 한 트랜잭션이 수행 중일 때, 다른 트랜잭션이 값을 수정 또는 삭제함으로써 나타난다.
- **Phantom read**
    - 한 트랜잭션에서 같은 쿼리를 두 번 수행할 때, 첫 번째 쿼리에서 없던 레코드가 두 번째 쿼리에서 나타나는 현상
    - 한 트랜잭션이 수행 중일 때, 다른 트랜잭션이 새로운 레코드를 INSERT 함으로써 나타난다.

<br/>
<br/>

**Level 0 : READ UNCOMMITTED - DB의 일관성 유지가 불가능하다.**

- 일반적인 데이터베이스에서는 거의 사용하지 않는다.
- 어떤 트랜잭션이 처리하고 있는 작업이 **모두 완료되지 않았음에도 다른 트랜잭션에서 보고 사용할 수 있다.** (쿼리가 반영된 값이 아니므로 취소가 될 수도 있고, 변경도 가능하다)
    - **Dirty read에 따른 데이터의 정합성 문제를 많이 일으키기에 잘 사용하지 않는다.**
    - **MySQL에선 최소한 READ COMMITTED 수준을 사용할 것을 권장한다.**
    - **Dirty read, Non-Repeatable read, Phantom read**

<br/>

**Level 1 : READ COMMITTED - Default 설정. 조작하는 데이터에만 Shared Lock 이 걸린다.**

- 커밋이 완료된 데이터에 대해서만(테이블 반영 후) 다른 트랜잭션에서 조회할 수 있다,
- 업데이트 대상들은 Undo 영역으로 백업되어 커밋 전까지 다른 트랜잭션들은 Undo 영역을 참조하여 사용한다.
- **하나의 트랜잭션이 실행되는 동안 다른 트랜잭션의 커밋을 통해 데이터 변경**이 일어나면 이후 **내부에서 조회하는 결과가 달라져 Non-Repeatable read** 문제가 발생할 수있다.
- **Non-Repeatable read, Phantom read**

<br/>

**Level 2 : REPEATABLE READ - 트랜잭션이 접근한 모든 영역에 Shared Lock이 걸리는 상태**

- InnoDB 스토리지 엔진에서 기본적으로 사용되는 격리 수준이다.
- MVCC를 이용하여 트랜잭션에 번호를 지정하여 해당 트랜잭션의 이전 번호를 가진 트랜잭션을 통한 데이터만을 참조한다.
- Undo 공간에 데이터를 백업해두고 레코드를 변경하며, 백업된 데이터는 필요치 않을 때 주기적으로 삭제한다. **(백업된 데이터가 많아질수록 처리 성능에 영향을 준다.)**
- PHANTOM READ가 발생한다.
    - 다른 트랜잭션이 **수행하는 변경 작업**에 의하여서 **실제 레코드가 가려지는 현상. 혹은 없었던 레코드가 생겨나는 현상.**
        - 이를 방지하기 위해서는 **쓰기 잠금**을 걸어야한다. (데이터 업데이트 시 다른      트랜잭션은 조회하지 못하고 대기한다.)

<br/>

**Level 3 : SERIALIZABLE** 

- 동시성이 중요한 데이터베이스에서는 거의 사용하지 않는다.
- 가장 단순한 격리 수준이지만 매우 엄격하다. (성능이 매우 떨어진다)